<VirtualHost *:8123>
    ServerName trac.local
    DocumentRoot /var/www/html

    # Static pages directory
    DirectoryIndex login.html
    <Directory /var/www/html>
        Require all granted
        Options Indexes FollowSymLinks
        AllowOverride None
    </Directory>

    # Login form handler
    <Location /dologin>
        SetHandler form-login-handler
        AuthFormProvider ldap
        AuthLDAPURL "ldap://openldap:389/ou=users,dc=example,dc=org?uid"
        AuthLDAPBindDN "cn=admin,dc=example,dc=org"
        AuthLDAPBindPassword admin
        AuthType form
        AuthName "Trac Authentication"

        Session On
        SessionCookieName trac_session path=/
        SessionCryptoPassphrase "change-this-to-a-secure-random-string-min-16-chars"
        SessionHeader X-Replace-Session
        SessionMaxAge 3600

        # Redirect to Trac after successful login
        AuthFormLoginSuccessLocation /trac

        # Redirect to login form on failure
        ErrorDocument 401 /login?error=1
    </Location>

    # Logout handler
    <Location /dologout>
        SetHandler form-logout-handler
        AuthFormLogoutLocation /logout-complete

        Session On
        SessionCookieName trac_session path=/
        SessionMaxAge 1
        Require all granted

    </Location>

    # Trac application under /trac path with session-based auth
    WSGIScriptAlias /trac /var/local/trac/cgi-bin/trac.wsgi
    <Directory /var/local/trac/cgi-bin>
        WSGIApplicationGroup %{GLOBAL}
        WSGIPassAuthorization On
        Require all granted
    </Directory>



    # Authentication required for /trac path
    <Location /trac>
        AuthType form
        AuthName "Trac Authentication"
        AuthFormProvider ldap
        AuthLDAPURL "ldap://openldap:389/ou=users,dc=example,dc=org?uid?sub?(objectClass=inetOrgPerson)"
        AuthLDAPBindDN "cn=admin,dc=example,dc=org"
        AuthLDAPBindPassword admin
        # Get additional LDAP attributes
        AuthLDAPSearchAsUser on
        AuthLDAPCompareAsUser on

        # Session configuration
        Session On
        SessionCookieName trac_session path=/
        SessionCryptoPassphrase "change-this-to-a-secure-random-string-min-16-chars"
        SessionHeader X-Replace-Session
        SessionMaxAge 3600

        # Redirect unauthenticated users to login
        AuthFormLoginRequiredLocation /login

        Require valid-user

        # Set headers for Trac (get LDAP attributes)
        RequestHeader set X-Debug-User "%{REMOTE_USER}s"
        RequestHeader set X-FULLNAME "%{AUTHENTICATE_cn}e"
        RequestHeader set X-EMAIL "%{AUTHENTICATE_mail}e"

        # Prevent caching of authenticated pages
        Header always set Cache-Control "no-cache, no-store, must-revalidate max-age=0, private"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
        Header always set Vary "Cookie"
        Header always set Surrogate-Control "no-store"

        AddOutputFilterByType SUBSTITUTE text/html
        Substitute "s#</body>#<script>window.addEventListener('pageshow',function(e){if(e.persisted){window.location.reload();}});</script></body>#i"
    </Location>

    # Handle /trac/logout explicitly (Trac's default logout link)
<Location "/trac/logout">
    SetHandler form-logout-handler
    AuthFormLogoutLocation /logout-complete

    # Must match your session config (same cookie name & crypto key)
    Session On
    SessionCookieName trac_session path=/
    SessionCryptoPassphrase "change-this-to-a-secure-random-string-min-16-chars"

    # This endpoint should be public so it can clear the cookie even if the session expired
    Require all granted

    # Strongly discourage caching
    Header always set Cache-Control "no-cache, no-store, must-revalidate,max-age=0"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
</Location>

    # Public access to login page
    <Location /login>
        Require all granted
        AuthType None
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
    </Location>

    # Public access to logout success page
    <Location /logout-complete>
        Require all granted
        AuthType None
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
    </Location>

    # Static aliases
    Alias /login /var/www/html/login.html
    Alias /logout-complete /var/www/html/logout-complete.html

    # Redirect root to login page
    RedirectMatch ^/$ /login

    # Security headers
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

</VirtualHost>
